{% extends "base.html" %}

{% block title %}Shift Scheduler - Home{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h1><i class="fas fa-calendar-alt me-2"></i>Shift Scheduler</h1>
        <p class="lead">Schedule shifts for your engineering team across multiple workplaces</p>
    </div>
    <div class="col-md-6 text-end d-flex flex-column justify-content-end align-items-end">
        <div class="mb-2 small text-muted">
            <i class="fas fa-info-circle me-1"></i> If the Generate Excel button doesn't work, try the Excel Generator page.
        </div>
        <div>
            <button id="btnGenerate" class="btn btn-success me-2">
                <i class="fas fa-file-excel me-1"></i> Generate Excel
            </button>
            <a href="/excel-generator" class="btn btn-outline-success">
                <i class="fas fa-file-excel me-1"></i> Excel Generator
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left Panel - Engineers -->
    <div class="col-md-3">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i>Engineers</h5>
            </div>
            <div class="card-body">
                <div id="engineersList">
                    <!-- Engineers will be displayed here -->
                </div>
                <hr>
                <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addEngineerModal">
                    <i class="fas fa-plus me-1"></i> Add Engineer
                </button>
            </div>
        </div>
    </div>
    
    <!-- Right Panel - Scheduling -->
    <div class="col-md-9">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Shift Scheduler</h5>
                    <div>
                        <select id="monthSelect" class="form-select form-select-sm d-inline-block me-2" style="width: 150px;">
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                        <select id="yearSelect" class="form-select form-select-sm d-inline-block" style="width: 100px;">
                            <!-- Years will be populated dynamically -->
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <ul class="nav nav-tabs nav-fill" id="workplaceTabs" role="tablist">
                    {% for workplace in workplaces %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if loop.first %}active{% endif %}" 
                                id="tab-{{ workplace|replace(' ', '-')|lower }}" 
                                data-bs-toggle="tab" 
                                data-bs-target="#content-{{ workplace|replace(' ', '-')|lower }}" 
                                type="button" 
                                role="tab">
                            {{ workplace }}
                        </button>
                    </li>
                    {% endfor %}
                </ul>
                <div class="tab-content p-3" id="workplaceTabContent">
                    {% for workplace in workplaces %}
                    <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                         id="content-{{ workplace|replace(' ', '-')|lower }}" 
                         role="tabpanel">
                        <div id="schedule-{{ workplace|replace(' ', '-')|lower }}">
                            <!-- Schedule table will be generated here -->
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="card-footer text-end">
                <button id="btnAutoAssign" class="btn btn-warning me-2">
                    <i class="fas fa-magic me-1"></i> Auto-Assign Engineers
                </button>
                <button id="btnSaveSchedule" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i> Save Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Engineer Modal -->
<div class="modal fade" id="addEngineerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Add/Edit Engineer</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="engineerForm">
                    <div class="mb-3">
                        <label for="engineerName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="engineerName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Workplaces</label>
                        {% for workplace in workplaces %}
                        <div class="form-check">
                            <input class="form-check-input workplace-check" type="checkbox" value="{{ workplace }}" id="check-{{ workplace|replace(' ', '-')|lower }}">
                            <label class="form-check-label" for="check-{{ workplace|replace(' ', '-')|lower }}">
                                {{ workplace }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnSaveEngineer">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Excel Generated Modal -->
<div class="modal fade" id="excelGeneratedModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Excel Files Generated</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Excel files have been generated successfully!</p>
                <ul id="downloadList" class="list-group">
                    <!-- Download links will be generated here -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Assignment Summary Modal -->
<div class="modal fade" id="assignmentSummaryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-magic me-2"></i>Auto-Assignment Complete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Summary content will be generated dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Global variables
    let engineers = [];
    let currentSchedule = {};
    
    // Initialize current date
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth() + 1; // JavaScript months are 0-indexed
    const currentYear = currentDate.getFullYear();
    
    // Populate year dropdown (current year Â± 5 years)
    const yearSelect = document.getElementById('yearSelect');
    for (let year = currentYear - 5; year <= currentYear + 5; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) {
            option.selected = true;
        }
        yearSelect.appendChild(option);
    }
    
    // Set current month
    document.getElementById('monthSelect').value = currentMonth;
    
    // Load engineers on page load
    loadEngineers();
    
    // Event listeners
    document.getElementById('btnSaveEngineer').addEventListener('click', saveEngineer);
    document.getElementById('btnSaveSchedule').addEventListener('click', saveSchedule);
    document.getElementById('btnGenerate').addEventListener('click', generateExcel);
    document.getElementById('monthSelect').addEventListener('change', generateCalendars);
    document.getElementById('yearSelect').addEventListener('change', generateCalendars);
    document.getElementById('btnAutoAssign').addEventListener('click', autoAssignEngineers);
    
    // Functions
    function loadEngineers() {
        fetch('/api/engineers')
            .then(response => response.json())
            .then(data => {
                engineers = data;
                updateEngineersList();
                generateCalendars();
            })
            .catch(error => {
                console.error('Error loading engineers:', error);
                alert('Failed to load engineers. Please try again.');
            });
    }
    
    function updateEngineersList() {
        const engineersList = document.getElementById('engineersList');
        engineersList.innerHTML = '';
        
        if (engineers.length === 0) {
            engineersList.innerHTML = '<div class="alert alert-info">No engineers added yet.</div>';
            return;
        }
        
        engineers.forEach(eng => {
            const card = document.createElement('div');
            card.classList.add('card', 'mb-2');
            
            const cardBody = document.createElement('div');
            cardBody.classList.add('card-body', 'p-2');
            
            const nameRow = document.createElement('div');
            nameRow.classList.add('d-flex', 'justify-content-between', 'align-items-center');
            
            const name = document.createElement('h6');
            name.classList.add('mb-1');
            name.textContent = eng.name;
            
            const actions = document.createElement('div');
            
            const editBtn = document.createElement('button');
            editBtn.classList.add('btn', 'btn-sm', 'btn-outline-primary', 'me-1');
            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
            editBtn.addEventListener('click', () => editEngineer(eng));
            
            const deleteBtn = document.createElement('button');
            deleteBtn.classList.add('btn', 'btn-sm', 'btn-outline-danger');
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.addEventListener('click', () => deleteEngineer(eng.name));
            
            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);
            
            nameRow.appendChild(name);
            nameRow.appendChild(actions);
            
            const workplaces = document.createElement('small');
            workplaces.classList.add('text-muted');
            workplaces.textContent = `Workplaces: ${eng.workplaces.join(', ')}`;
            
            cardBody.appendChild(nameRow);
            cardBody.appendChild(workplaces);
            
            card.appendChild(cardBody);
            engineersList.appendChild(card);
        });
    }
    
    function editEngineer(engineer) {
        // Fill form
        document.getElementById('engineerName').value = engineer.name;
        
        // Uncheck all workplaces
        document.querySelectorAll('.workplace-check').forEach(check => {
            check.checked = false;
        });
        
        // Check relevant workplaces
        engineer.workplaces.forEach(workplace => {
            const checkId = `check-${workplace.replace(/ /g, '-').toLowerCase()}`;
            const checkbox = document.getElementById(checkId);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
        
        // Show modal
        new bootstrap.Modal(document.getElementById('addEngineerModal')).show();
    }
    
    function saveEngineer() {
        const name = document.getElementById('engineerName').value.trim();
        if (!name) {
            alert('Please enter engineer name');
            return;
        }
        
        const workplaces = [];
        document.querySelectorAll('.workplace-check:checked').forEach(check => {
            workplaces.push(check.value);
        });
        
        if (workplaces.length === 0) {
            alert('Please select at least one workplace');
            return;
        }
        
        fetch('/api/engineers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name,
                workplaces
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Reset form
                document.getElementById('engineerForm').reset();
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addEngineerModal')).hide();
                
                // Reload engineers
                loadEngineers();
            }
        })
        .catch(error => {
            console.error('Error saving engineer:', error);
            alert('Failed to save engineer. Please try again.');
        });
    }
    
    function deleteEngineer(name) {
        if (confirm(`Are you sure you want to delete ${name}?`)) {
            fetch(`/api/engineers/${name}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Reload engineers
                    loadEngineers();
                }
            })
            .catch(error => {
                console.error('Error deleting engineer:', error);
                alert('Failed to delete engineer. Please try again.');
            });
        }
    }
    
    function generateCalendars() {
        const month = parseInt(document.getElementById('monthSelect').value);
        const year = parseInt(document.getElementById('yearSelect').value);
        
        // Get number of days in the month
        const daysInMonth = new Date(year, month, 0).getDate();
        
        // For each workplace, generate the table
        document.querySelectorAll('[id^="schedule-"]').forEach(container => {
            const workplaceId = container.id.replace('schedule-', '');
            const workplaceName = workplaceId.split('-').map(part => 
                part.charAt(0).toUpperCase() + part.slice(1)
            ).join(' ');
            
            // Create table
            const table = document.createElement('table');
            table.className = 'table table-bordered';
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const headers = ['Day', 'Shift 1', 'Shift 2', 'Shift 3'];
            
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday
                const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                
                const row = document.createElement('tr');
                if (isWeekend) {
                    row.classList.add('table-light');
                }
                
                // Day column
                const dayCell = document.createElement('td');
                dayCell.textContent = `${day} - ${date.toLocaleDateString('en-US', { weekday: 'short' })}`;
                row.appendChild(dayCell);
                
                // Shift columns
                for (let shift = 1; shift <= 3; shift++) {
                    const cell = document.createElement('td');
                    
                    const select = document.createElement('select');
                    select.className = 'form-select engineer-select';
                    select.dataset.day = day;
                    select.dataset.shift = `shift${shift}`;
                    select.dataset.workplace = workplaceName;
                    
                    // Empty option
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = '-- Select Engineer --';
                    select.appendChild(emptyOption);
                    
                    // Filter engineers who can work in this workplace
                    engineers.filter(eng => eng.workplaces.includes(workplaceName))
                            .forEach(eng => {
                                const option = document.createElement('option');
                                option.value = eng.name;
                                option.textContent = eng.name;
                                select.appendChild(option);
                            });
                    
                    cell.appendChild(select);
                    row.appendChild(cell);
                }
                
                tbody.appendChild(row);
            }
            
            table.appendChild(tbody);
            container.innerHTML = '';
            container.appendChild(table);
        });
        
        // Load schedule for this month/year
        loadSchedule(year, month);
    }
    
    function loadSchedule(year, month) {
        fetch(`/api/schedule?year=${year}&month=${month}`)
            .then(response => response.json())
            .then(data => {
                currentSchedule = data;
                
                // Fill in the select fields
                document.querySelectorAll('.engineer-select').forEach(select => {
                    const workplace = select.dataset.workplace;
                    const day = select.dataset.day;
                    const shift = select.dataset.shift;
                    
                    if (currentSchedule[workplace] && 
                        currentSchedule[workplace][day] && 
                        currentSchedule[workplace][day][shift]) {
                        select.value = currentSchedule[workplace][day][shift];
                    } else {
                        select.value = '';
                    }
                });
            })
            .catch(error => {
                console.error('Error loading schedule:', error);
            });
    }
    
    function saveSchedule() {
        const month = parseInt(document.getElementById('monthSelect').value);
        const year = parseInt(document.getElementById('yearSelect').value);
        
        // Collect schedule data
        const workplaces = {};
        
        document.querySelectorAll('.engineer-select').forEach(select => {
            if (select.value) {
                const workplace = select.dataset.workplace;
                const day = select.dataset.day;
                const shift = select.dataset.shift;
                
                if (!workplaces[workplace]) {
                    workplaces[workplace] = {};
                }
                
                if (!workplaces[workplace][day]) {
                    workplaces[workplace][day] = {};
                }
                
                workplaces[workplace][day][shift] = select.value;
            }
        });
        
        fetch('/api/schedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                year,
                month,
                workplaces
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Schedule saved successfully!');
                // Reload schedule
                loadSchedule(year, month);
            }
        })
        .catch(error => {
            console.error('Error saving schedule:', error);
            alert('Failed to save schedule. Please try again.');
        });
    }
    
    function generateExcel() {
        const month = parseInt(document.getElementById('monthSelect').value);
        const year = parseInt(document.getElementById('yearSelect').value);
        
        fetch('/api/generate_excel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                year,
                month
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to generate Excel files');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                const downloadList = document.getElementById('downloadList');
                downloadList.innerHTML = '';
                
                data.files.forEach(file => {
                    const li = document.createElement('li');
                    li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                    
                    const fileName = document.createElement('span');
                    fileName.textContent = file;
                    
                    const downloadLink = document.createElement('a');
                    downloadLink.href = `/api/download/${file}`;
                    downloadLink.classList.add('btn', 'btn-sm', 'btn-outline-primary');
                    downloadLink.innerHTML = '<i class="fas fa-download me-1"></i> Download';
                    downloadLink.download = file;
                    
                    li.appendChild(fileName);
                    li.appendChild(downloadLink);
                    downloadList.appendChild(li);
                });
                
                // Show modal
                new bootstrap.Modal(document.getElementById('excelGeneratedModal')).show();
            }
        })
        .catch(error => {
            console.error('Error generating Excel files:', error);
            alert('Failed to generate Excel files. Please make sure you have saved the schedule.');
        });
    }
    
    function autoAssignEngineers() {
        // Implementation of auto-assigning engineers
        alert('Auto-assigning engineers');
    }
});
</script>
{% endblock %}